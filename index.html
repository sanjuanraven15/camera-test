<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Camera Capture Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1a1a1a;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .camera-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .loading-screen {
            text-align: center;
            color: white;
        }

        .loading-emoji {
            font-size: 48px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .loading-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 12px;
            color: #888;
            max-width: 250px;
            margin: 0 auto;
            line-height: 1.4;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #capturedImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        #canvas {
            display: none;
        }

        .camera-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: none;
        }

        .camera-selector select {
            background: rgba(0,0,0,0.8);
            color: white;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 120px;
        }

        .controls {
            background: #1a1a1a;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            border-top: 1px solid #333;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-capture {
            background: #4CAF50;
            color: white;
        }

        .btn-retake {
            background: #FF9800;
            color: white;
        }

        .btn-download {
            background: #2196F3;
            color: white;
        }

        .btn-cancel {
            background: #F44336;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .error-screen {
            text-align: center;
            padding: 40px 20px;
            color: #ff6b6b;
        }

        .error-emoji {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .error-message {
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto;
        }

        .info-panel {
            background: #2a2a2a;
            margin: 10px;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
        }

        .info-panel h3 {
            margin-bottom: 8px;
            color: #4CAF50;
            font-size: 14px;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }

        .status-indicator.active {
            display: block;
        }

        .status-indicator.recording {
            background: #f44336;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        @media (max-width: 480px) {
            .controls {
                padding: 15px;
                gap: 8px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 12px;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì± Mobile Camera Test</h1>
    </div>

    <div class="camera-container">
        <div id="loadingScreen" class="loading-screen">
            <div class="loading-emoji">üì∑</div>
            <div class="loading-text">Initializing Camera...</div>
            <div class="loading-subtext">Please allow camera access when prompted. This works with both webcam and mobile camera.</div>
        </div>

        <div id="errorScreen" class="error-screen" style="display: none;">
            <div class="error-emoji">‚ùå</div>
            <div class="error-title">Camera Error</div>
            <div id="errorMessage" class="error-message"></div>
        </div>

        <div class="status-indicator" id="statusIndicator">
            üî¥ Camera Active
        </div>

        <div class="camera-selector" id="cameraSelector">
            <select id="cameraSelect">
                <option value="">Select Camera...</option>
            </select>
        </div>

        <video id="video" autoplay playsinline muted></video>
        <img id="capturedImage" alt="Captured photo">
        <canvas id="canvas"></canvas>
    </div>

    <div class="info-panel">
        <h3>üìã Test Information</h3>
        <div id="cameraInfo">Detecting cameras...</div>
        <div id="browserInfo"></div>
    </div>

    <div class="controls">
        <button id="captureBtn" class="btn btn-capture" style="display: none;">
            üì∏ Capture
        </button>
        <button id="retakeBtn" class="btn btn-retake" style="display: none;">
            üîÑ Retake
        </button>
        <button id="downloadBtn" class="btn btn-download" style="display: none;">
            üíæ Download
        </button>
        <button id="testAgainBtn" class="btn btn-cancel" onclick="location.reload()">
            üîÑ Test Again
        </button>
    </div>

    <script>
        class MobileCameraTest {
            constructor() {
                this.stream = null;
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.capturedImage = document.getElementById('capturedImage');
                this.availableCameras = [];
                this.currentCameraIndex = 0;
                
                this.initializeElements();
                this.detectBrowser();
                this.initializeCamera();
            }

            initializeElements() {
                this.loadingScreen = document.getElementById('loadingScreen');
                this.errorScreen = document.getElementById('errorScreen');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.cameraSelector = document.getElementById('cameraSelector');
                this.cameraSelect = document.getElementById('cameraSelect');
                this.captureBtn = document.getElementById('captureBtn');
                this.retakeBtn = document.getElementById('retakeBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.cameraInfo = document.getElementById('cameraInfo');
                this.errorMessage = document.getElementById('errorMessage');

                // Event listeners
                this.captureBtn.addEventListener('click', () => this.captureImage());
                this.retakeBtn.addEventListener('click', () => this.retakePhoto());
                this.downloadBtn.addEventListener('click', () => this.downloadImage());
                this.cameraSelect.addEventListener('change', (e) => this.switchCamera(e.target.value));
            }

            detectBrowser() {
                const browserInfo = document.getElementById('browserInfo');
                const isWebView = /wv/.test(navigator.userAgent);
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                let info = `üåê Browser: ${navigator.userAgent.split(' ')[0]} | `;
                info += `üì± Mobile: ${isMobile ? 'Yes' : 'No'} | `;
                info += `üîß WebView: ${isWebView ? 'Yes' : 'No'}`;
                
                if (isIOS) info += ' | üçé iOS';
                if (isAndroid) info += ' | ü§ñ Android';
                
                browserInfo.textContent = info;
            }

            async initializeCamera() {
                try {
                    // Check if camera is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera not supported in this browser');
                    }

                    // Get available cameras
                    await this.getAvailableCameras();
                    
                    // Start with back camera (environment) for mobile
                    await this.startCamera();
                    
                    // Show camera selector if multiple cameras
                    if (this.availableCameras.length > 1) {
                        this.populateCameraSelector();
                        this.cameraSelector.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Camera initialization failed:', error);
                    this.showError('Failed to access camera', error.message);
                }
            }

            async getAvailableCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.availableCameras = devices.filter(device => device.kind === 'videoinput');
                    
                    let cameraText = `üìπ Found ${this.availableCameras.length} camera(s): `;
                    this.availableCameras.forEach((camera, index) => {
                        const label = camera.label || `Camera ${index + 1}`;
                        cameraText += `${index > 0 ? ', ' : ''}${label}`;
                    });
                    
                    this.cameraInfo.textContent = cameraText;
                } catch (error) {
                    console.error('Failed to enumerate cameras:', error);
                    this.cameraInfo.textContent = '‚ùå Could not detect cameras';
                }
            }

            populateCameraSelector() {
                this.cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
                
                this.availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `Camera ${index + 1}`;
                    
                    // Try to identify camera types
                    const label = camera.label.toLowerCase();
                    if (label.includes('front') || label.includes('user')) {
                        option.textContent += ' (Front)';
                    } else if (label.includes('back') || label.includes('environment')) {
                        option.textContent += ' (Back)';
                    }
                    
                    this.cameraSelect.appendChild(option);
                });
            }

            async startCamera(deviceId = null) {
                try {
                    // Stop existing stream
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }

                    // Camera constraints - prefer back camera on mobile
                    const constraints = {
                        video: {
                            width: { ideal: 1920, max: 1920 },
                            height: { ideal: 1080, max: 1080 }
                        }
                    };

                    if (deviceId) {
                        constraints.video.deviceId = { exact: deviceId };
                    } else {
                        // Try back camera first on mobile
                        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                        if (isMobile) {
                            constraints.video.facingMode = { ideal: 'environment' };
                        }
                    }

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    this.video.onloadedmetadata = () => {
                        this.hideLoading();
                        this.showCamera();
                        
                        // Set canvas dimensions
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        
                        this.statusIndicator.classList.add('active');
                        
                        // Log camera info
                        const track = this.stream.getVideoTracks()[0];
                        const settings = track.getSettings();
                        console.log('Camera settings:', settings);
                        
                        this.cameraInfo.innerHTML += `<br>üìê Resolution: ${settings.width}√ó${settings.height}`;
                    };

                } catch (error) {
                    console.error('Failed to start camera:', error);
                    
                    // Try fallback to front camera if back camera fails
                    if (!deviceId && error.name === 'OverconstrainedError') {
                        try {
                            const fallbackConstraints = {
                                video: {
                                    width: { ideal: 1920, max: 1920 },
                                    height: { ideal: 1080, max: 1080 },
                                    facingMode: { ideal: 'user' }
                                }
                            };
                            
                            this.stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                            this.video.srcObject = this.stream;
                            
                            this.video.onloadedmetadata = () => {
                                this.hideLoading();
                                this.showCamera();
                                this.canvas.width = this.video.videoWidth;
                                this.canvas.height = this.video.videoHeight;
                                this.statusIndicator.classList.add('active');
                            };
                        } catch (fallbackError) {
                            throw fallbackError;
                        }
                    } else {
                        throw error;
                    }
                }
            }

            switchCamera(deviceId) {
                if (deviceId) {
                    this.loadingScreen.style.display = 'block';
                    this.video.style.display = 'none';
                    this.captureBtn.style.display = 'none';
                    this.statusIndicator.classList.remove('active');
                    this.startCamera(deviceId);
                }
            }

            captureImage() {
                if (this.video.videoWidth && this.video.videoHeight) {
                    // Set canvas size to match video
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                    
                    // Draw current frame
                    this.ctx.drawImage(this.video, 0, 0);
                    
                    // Convert to data URL and show
                    const dataURL = this.canvas.toDataURL('image/jpeg', 0.9);
                    this.capturedImage.src = dataURL;
                    
                    // Update UI
                    this.showCapturedImage();
                    
                    console.log('Image captured successfully');
                    this.cameraInfo.innerHTML += '<br>‚úÖ Image captured successfully!';
                }
            }

            retakePhoto() {
                this.showCamera();
            }

            downloadImage() {
                const dataURL = this.canvas.toDataURL('image/jpeg', 0.9);
                const link = document.createElement('a');
                link.download = `camera-capture-${new Date().getTime()}.jpg`;
                link.href = dataURL;
                link.click();
            }

            showCamera() {
                this.video.style.display = 'block';
                this.capturedImage.style.display = 'none';
                this.captureBtn.style.display = 'inline-flex';
                this.retakeBtn.style.display = 'none';
                this.downloadBtn.style.display = 'none';
                this.statusIndicator.classList.add('active');
            }

            showCapturedImage() {
                this.video.style.display = 'none';
                this.capturedImage.style.display = 'block';
                this.captureBtn.style.display = 'none';
                this.retakeBtn.style.display = 'inline-flex';
                this.downloadBtn.style.display = 'inline-flex';
                this.statusIndicator.classList.remove('active');
            }

            hideLoading() {
                this.loadingScreen.style.display = 'none';
                this.errorScreen.style.display = 'none';
            }

            showError(title, message) {
                this.loadingScreen.style.display = 'none';
                this.errorScreen.style.display = 'block';
                document.querySelector('.error-title').textContent = title;
                this.errorMessage.textContent = message;
                this.cameraInfo.innerHTML += `<br>‚ùå Error: ${message}`;
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            new MobileCameraTest();
        });

        // Handle page visibility changes (mobile optimization)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                // Pause video when page is hidden (battery optimization)
                const video = document.getElementById('video');
                if (video && video.srcObject) {
                    video.pause();
                }
            } else {
                // Resume video when page is visible
                const video = document.getElementById('video');
                if (video && video.srcObject) {
                    video.play();
                }
            }
        });
    </script>
</body>
</html>
